<!DOCTYPE html>
<html>
  <head>
    <title>testolin2020_experiment</title>
    <script src="https://unpkg.com/jspsych@8.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.0.0"></script>
    <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
  </head>
  <style>
  body {
    background-color: black;
    color: white;
  }
  .fixation-cross {
    font-size: 48px;
    text-align: center;
    line-height: 100vh;
  }
  .stim-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 500px; /* controls distance between left/right images */
    height: 100vh;
  }
  .stim-img {
    width: 500px;
    height: 500px;
    object-fit: contain;
  }

  .consent-box {
    max-width: 800px;
    margin: auto;
    padding: 30px;
    background-color: white;
    color: black;
    border-radius: 10px;
    text-align: left;
  }
  
  .consent-box h2 {
    text-align: center;
    color: #333;
  }
  
  .consent-box p, .consent-box ul {
    font-size: 14px;
    line-height: 1.6;
  }
  
  .consent-box ul {
    margin-left: 20px;
  }

  .screen-size-container {
    max-width: 700px;
    margin: auto;
    padding: 30px;
    background-color: white;
    color: black;
    border-radius: 10px;
    text-align: center;
  }
  
  .screen-size-container h2 {
    color: #333;
    margin-bottom: 20px;
  }
  
  .screen-size-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin: 30px 0;
    text-align: left;
  }
  
  .screen-size-option {
    padding: 15px;
    border: 2px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    background-color: #f9f9f9;
    text-align: left;
  }
  
  .screen-size-option:hover {
    border-color: #4CAF50;
    background-color: #e8f5e9;
  }
  
  .screen-size-option input[type="radio"] {
    margin-right: 10px;
    transform: scale(1.3);
  }
  
  .screen-size-option label {
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    color: black; 
  }
  
  .screen-info {
    margin-top: 20px;
    padding: 15px;
    background-color: #fff3cd;
    color: #856404;
    border-radius: 5px;
    font-size: 14px;
  }
</style>
  <body></body>
   <script>

    const MASK_PATH = 'paired_images/mask_bw.png';     // no leading slash
    const PAIRS_JSON_PATH = 'pairs_metadata.json';      // no leading slash
    const DEMO_LEFT_FIXDOT   = 'paired_images/demo_img_01792.png'; // page 3 left
    const DEMO_RIGHT_FIXDOT  = 'paired_images/demo_img_00343.png'; // page 3 right
    const DEMO_LEFT_PRACTICE = 'paired_images/demo_img_01589.png'; // page 7 left
    const DEMO_RIGHT_PRACTICE= 'paired_images/demo_img_01691.png';
    const LEFT_KEY  = 'f';
    const RIGHT_KEY = 'j';
    const DATAPIPE_EXPERIMENT_ID = "GTzMyrVFaoMb";
    

    const jsPsych = initJsPsych({
      on_trial_finish: function(data) {
        if (data.task === 'numerosity_discrimination') {
          const trial_count = jsPsych.data.get().filter({task: 'numerosity_discrimination'}).count();
          if (trial_count % 100 === 0) {
            saveDataToOSF();
          }
        }
      }
    });
    
    const participant_id = jsPsych.randomization.randomID(10);

    function seededRandom(seed) {
      let state = seed;
      return function() {
        state = (state * 1664525 + 1013904223) % 4294967296;
        return state / 4294967296;
      };
    }

    const rng = seededRandom(12345);

    function saveDataToOSF(is_final = false) {
      const trial_data = jsPsych.data.get().filter({task: 'numerosity_discrimination'});
      if (trial_data.count() === 0) return;
      const filename = `${participant_id}_${is_final ? 'final' : 'partial'}_${Date.now()}.csv`;
      fetch(`https://pipe.jspsych.org/api/data/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': '*/*'
        },
        body: JSON.stringify({
        experimentID: DATAPIPE_EXPERIMENT_ID,
        filename: filename,
        data: trial_data.csv()
        })
      })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      console.log(`Data ${is_final ? 'final' : 'partial'} save successful`);
    })
    .catch(error => {
      console.error('Error saving to DataPipe:', error);
      alert('Data save to server failed. File will download to your computer.');
    });
    }

    window.addEventListener('beforeunload', function(e) {
      const trial_data = jsPsych.data.get().filter({task: 'numerosity_discrimination'});
      if (trial_data.count() > 0) {
        saveDataToOSF();
      }
    });

    
    // ---- main: load metadata, then build timeline, then run ----
    fetch(PAIRS_JSON_PATH)
      .then(response => response.json())
      .then(raw_rows => {
        console.log("Loaded metadata rows:", raw_rows.length);
        const pairs = groupRowsIntoPairs(raw_rows);

        // NO shuffle if you want same order for everyone
        const block1 = pairs.slice(0, 100);
        const block2 = pairs.slice(100, 200);
        const block3 = pairs.slice(200, 300);

        const timeline = [];

        jsPsych.data.addProperties({
      participant_id: participant_id,
      experiment: 'testolin2020_replication',
      date: new Date().toISOString()
    });

        // CONSENT FORM
        const consent_form = {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `
            <div class="consent-box">
              <h2>Consent</h2>
              
              <p>You are being invited to participate in a research study titled “Reproducibility of Psychological Science and Instruction."
              This study is being done by Dr. Bria Long from UC San Diego and associated graduate students in Experimental Methods course.
              You were selected to participate in this study because you are an adult in the U.S. and have been a represented population in previous psychology studies.</p>
              
              <p>The purpose of this study is to better understand how well previously published studies in the psychological field replicate online and with different populations.
              Your participation in this research should last approximately 5-30 minutes  If you agree to take part in this study, you may be asked to view a set of stimuli,
              including pictures, sounds, written text, or videos and then giving some responses via key-presses, verbally, or with paper-and-pencil. We may also observe your
              choices or preferences among an array of stimuli.  These stimuli will be taken directly from or closely adapted from studies that already exist in the published
              psychological literature. Stimuli will include, e.g., pictures of objects and human faces, audio and video clips, short text passages, etc. None of the stimuli
              will be disturbing, threatening, or offensive. The online and in-person experiments described in this protocol will take no more than 30 minutes. An example game
              you might play would be to click on an image on the screen that matches a word you hear being said out loud. Your total expected time commitment for this study is
              between 5-30 minutes, and is specified in the study description.</p>

              <p>Your participation in this study is completely voluntary and you can withdraw at any time. Choosing not to participate or withdrawing will result in no penalty or loss 
              of benefits to which you are entitled. You are free to skip any question that you choose.</p>

              <p>We will not be asking for any personally identifying information, and we will handle responses as confidentially as possible. Your SONA or Prolific IDs will never 
              be tied to your responses on this survey. However, we cannot guarantee the confidentiality of information transmitted over the Internet. To minimize this risk, data 
              containing anything that might be personally identifiable (e.g. Prolific IDs or IP addresses) will be encrypted on transfer and storage and will only be accessible 
              to qualified lab personnel. We will be keeping data collected as part of this experiment indefinitely. This anonymized data (containing neither Prolific IDs nor IP 
              addresses) may be shared with the scientific community or with other participants to be used as stimuli in future studies.</p>

              <p>If you have questions about this project or if you have a research-related problem, you may contact the researcher Anna Cao (cwenqing@ucsd.edu), or Dr. Bria Long (brlong@ucsd.edu). 
              If you have any questions concerning your rights as a research subject, you may contact the UC San Diego Office of IRB Administration at irb@ucsd.edu or 858-246-4777.
              By participating in this research you are indicating that you are at least 18 years old, have read this consent form, and agree to participate in this research study.
              Please keep this consent form for your records.<p>
              
              <p>By proceeding, you indicate that:</p>
              <ul>
                <li>You are at least 18 years old</li>
                <li>You have read and understood the information in the consenet form above</li>
                <li>You voluntarily agree to participate in this study</li>
              </ul>
               <p>Press any key to continue.</p>
            </div>

            <p>Press any key to continue.</p>
          `
        };

        // SCREEN SIZE SELECTION
        const screen_size_selection = {
          type: jsPsychSurveyHtmlForm,
          preamble: `
            <div class="screen-size-container">
              <h2>Screen Size Information</h2>
              <p>To ensure the experiment validity, please tell us about your display. (11-16 inch laptop is preferred)</p>
              <p><strong>Please select your screen size:</strong></p>
            </div>
          `,
          html: `
            <div class="screen-size-options">
              <div class="screen-size-option">
                <input type="radio" id="laptop_small" name="screen_size" value="11-12 inch laptop" required>
                <label for="laptop_small">11-12 inch Laptop</label>
              </div>
              
              <div class="screen-size-option">
                <input type="radio" id="laptop_medium" name="screen_size" value="13-14 inch laptop">
                <label for="laptop_medium">13-14 inch Laptop</label>
              </div>
              
              <div class="screen-size-option">
                <input type="radio" id="laptop_large" name="screen_size" value="15-16 inch laptop">
                <label for="laptop_exarge">15-16 inch Laptop</label>
              </div>

              <div class="screen-size-option">
                <input type="radio" id="laptop_large" name="screen_size" value="17-19 inch laptop">
                <label for="laptop_xlarge">17-19 inch Laptop</label>
              </div>
              
              <div class="screen-size-option">
                <input type="radio" id="desktop_standard" name="screen_size" value="20-27 inch desktop monitor">
                <label for="desktop_standard">21-24 inch Desktop Monitor</label>
              </div>
              
              <div class="screen-size-option">
                <input type="radio" id="desktop_large" name="screen_size" value="27+ inch desktop monitor">
                <label for="desktop_large">27+ inch Desktop Monitor</label>
              </div>
            
          `,
          button_label: 'Continue',
          data: {
            task: 'screen_size_selection',
            screen_width_pixels: window.screen.width,
            screen_height_pixels: window.screen.height,
            window_width_pixels: window.innerWidth,
            window_height_pixels: window.innerHeight,
            pixel_ratio: window.devicePixelRatio
          },
          on_finish: function(data) {
            // Extract screen size from form response
            const response = data.response;
            data.screen_size_category = response.screen_size;
            
            // Add screen info to all future trials
            jsPsych.data.addProperties({
              screen_size_category: response.screen_size,
              screen_width_pixels: data.screen_width_pixels,
              screen_height_pixels: data.screen_height_pixels,
              window_width_pixels: data.window_width_pixels,
              window_height_pixels: data.window_height_pixels,
              pixel_ratio: data.pixel_ratio
            });
          }
        };

        const age_collection = {
        type: jsPsychSurveyHtmlForm,
        preamble: `
          <div class="screen-size-container">
            <h2>Participant Information</h2>
            <p>Please provide your age to help us understand our participant demographics.</p>
          </div>
        `,
        html: `
          <div class="screen-size-options">
            <div class="screen-size-option" style="text-align: left;">
              <label for="age" style="display: block; margin-bottom: 10px; color: black; font-size: 16px; font-weight: 500;">
                Please enter your age:
              </label>
              <input 
                type="number" 
                id="age" 
                name="age" 
                min="18" 
                max="120" 
                required
                style="width: 100px; padding: 8px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;"
                placeholder="e.g., 25"
              >
            </div>
          </div>
        `,
        button_label: 'Continue',
        data: {
          task: 'age_collection'
        },
        on_finish: function(data) {
          // Extract age from form response
          const response = data.response;
          data.participant_age = response.age;
          
          // Add age to all future trials
          jsPsych.data.addProperties({
            participant_age: response.age
          });
        }
      };
        
        const sona_info_collection = {
  type: jsPsychSurveyHtmlForm,
  preamble: `
    <div class="screen-size-container">
      <h2>SONA Information</h2>
      <p><strong style="color: #d32f2f;">Important:</strong> Please enter your SONA time slot to receive credit for this study.</p>
      <p style="color: #d32f2f;"><strong>Without your SONA time slot, we cannot award you credit.</strong></p>
    </div>
  `,
  html: `
    <div class="screen-size-options">
      <div class="screen-size-option" style="text-align: left;">
        <label for="time_slot" style="display: block; margin-bottom: 10px; color: black; font-size: 16px; font-weight: 500;">
          Time Slot: <span style="color: #d32f2f;">*</span>
        </label>
        <input 
          type="text" 
          id="time_slot" 
          name="time_slot"
          required
          style="width: 300px; padding: 8px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px;"
          placeholder="e.g., Nov 12, 2:00 PM" 
        >
        <p style="font-size: 14px; color: #666; margin-top: 5px;">
          Enter your assigned time slot.
        </p>
      </div>
    </div>
  `,
  button_label: 'Continue',
  data: {
    task: 'sona_info_collection'
  },
  on_finish: function(data) {
    const sonaResponse = data.response;
    data.time_slot = sonaResponse.time_slot 
    
    // Add SONA info to all future trials
    jsPsych.data.addProperties({
      time_slot: sonaResponse.time_slot 
    });
  }
};


        // preload all images
        const allStimPaths = pairs.flatMap(p => [p.left_img, p.right_img]);
        
        const demoImages = [
          DEMO_LEFT_FIXDOT,
          DEMO_RIGHT_FIXDOT,
          DEMO_LEFT_PRACTICE,
          DEMO_RIGHT_PRACTICE
        ];

        const preload = {
          type: jsPsychPreload,
          images: [...new Set(allStimPaths.concat([MASK_PATH]))]
        };
        timeline.push(preload);

        const instructions = {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `
            <div style="max-width: 800px; margin: auto; text-align:left;">
              <h2>Numerosity discrimination task</h2>
              <p>On each trial, you will see two dot patterns, one on the left and one on the right.</p>
              <p>Your task is to choose which side has <strong>more dots</strong>.</p>
              <p>Use the <strong>F</strong> key for the left image and <strong>J</strong> for the right image.</p>
              <p>In each trial, You'll see the following in this exact order:</p>
              <ul>
                <li>Fixation cross</li>
                <li>Two dot patterns</li>
                <li>Two noise mask</li>
                <li>Black screen (respond (F/J) here!)</li>
                <li>Blank interval before the next trial</li>
              </ul>
              <p>We'll walk through an example and a practice trial before you begin</p>
              <p>Press any key to continue.</p>
            </div>
          `
        };

        const instructions2 = {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `
              <p>At the beginning of each trial, you will see a <strong>fixation cross</strong> at the center of the screen for <strong>500 ms</strong>. 
                Please keep your eyes on this cross.</p>
              <p>Press any key to continue.</p>
          `
        };

        const instructions3 = {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `
            <p>Immediately after the fixation cross, you will see <strong>two dot patterns</strong>, one on the left and one on the right.</p>
        <p>These will be shown very briefly, for <strong>250 ms</strong>.</p>
        <p>Your job is to decide which side has <strong>more dots</strong>.</p> 
      <p>Press any key to continue.</p>
          `
        };

        const instructions4 = {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `
        <p>As soon as the dot patterns disappear, they will be replaced by <strong>two noise masks</strong> in the same locations.</p>
        <p>These masks will be shown for <strong>150 ms</strong>.</p>
      <p>Press any key to continue.</p>
          `
        };
        
        const instructions5 = {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `
    
      <p>After the masks, the screen will turn black and stay black until you respond.</p>
      <p>On each trial:</p>
      <p>If you think the <strong>left</strong> side had more dots, press <strong>F</strong>.</p>
      <p>If you think the <strong>right</strong> side had more dots, press <strong>J</strong>.</p>
      <p>After you make your choice, the experiment will automatically move on to the next trial.</p>
      <p>Press <strong>F</strong> or <strong>J</strong> to continue.</p>
    
  `,
          choices: [LEFT_KEY, RIGHT_KEY]
        };

        const instructions6 = {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `
      <p>You will complete <strong>3 blocks</strong> in total.</p>
      <p>Each block has <strong>100 trials</strong>. There will be a short break between blocks,
         but no break between individual trials.</p>
      <p>Next, you will do <strong>one practice trial</strong> to get a sense of the timing.</p>
      <p>Press any key to start the practice trial.</p>
  `
      };

      const practice_trial = {
  timeline: [
    // Fixation (500 ms)
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div class="fixation-cross">+</div>',
      choices: "NO_KEYS",
      trial_duration: 500
    },
    // Dot patterns (250 ms)
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="stim-container">
          <img src="${DEMO_LEFT_PRACTICE}"  class="stim-img">
          <img src="${DEMO_RIGHT_PRACTICE}" class="stim-img">
        </div>
      `,
      choices: "NO_KEYS",
      trial_duration: 250
    },
    // Noise masks (150 ms)
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="stim-container">
          <img src="${MASK_PATH}" class="stim-img">
          <img src="${MASK_PATH}" class="stim-img">
        </div>
      `,
      choices: "NO_KEYS",
      trial_duration: 150
    },
    // Black screen until response
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div style="width:100vw;height:100vh;background-color:black;"></div>',
      choices: [LEFT_KEY, RIGHT_KEY],
      response_ends_trial: true,
      data: {
        task: "practice",
        left_img: DEMO_LEFT_PRACTICE,
        right_img: DEMO_RIGHT_PRACTICE
      }
    },
    // ITI (1250–1750 ms)
    {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div style="width:100vw;height:100vh;background-color:black;"></div>',
      choices: "NO_KEYS",
      trial_duration: function() {
        return 1250 + Math.floor(Math.random() * 501);
      }
    }
  ]
};

        const instructions7 = {
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
      <p>You just completed a practice trial. Great job!</p>
      <p>When you are ready, press any key to begin the actual study.</p>
    </div>
  `
};
        timeline.push(consent_form);
        timeline.push(screen_size_selection);
        timeline.push(age_collection);
        timeline.push(sona_info_collection); 
        timeline.push(instructions);
        timeline.push(instructions2);
        timeline.push(instructions3);
        timeline.push(instructions4);
        timeline.push(instructions5);
        timeline.push(instructions6);
        timeline.push(practice_trial);
        timeline.push(instructions7);

        timeline.push(makeBlock(block1, 1));
        timeline.push(makeBreakScreen(1));
        timeline.push(makeBlock(block2, 2));
        timeline.push(makeBreakScreen(2));
        timeline.push(makeBlock(block3, 3));

        const final_screen = {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `
        <div style="max-width: 600px; margin: auto; text-align: center;">
          <p>Please wait while we save your data...</p>
          <div class="spinner" style="margin: 20px auto;"></div>
        </div>
      `,
          choices: "NO_KEYS",
          trial_duration: 2000,
          on_finish: function() {
          saveDataToOSF(true);
      }
    };
        timeline.push(final_screen);

        const thank_you = {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `
        <div style="max-width: 600px; margin: auto; text-align: center;">
          <h2>Thank you for participating!</h2>

          <p>This experiment investigates how humans perceive and discriminate between different quantities of objects.</p> 
          <p>We are specifically interested in understanding whether people rely primarily on the actual number of items,</p> 
          <p>or whether other visual features (like the total area covered by dots or how spaced out they are) also influence</p> 
          <p>numerical judgments. Your responses will help us better understand the cognitive mechanisms underlying number perception.</p>

          <p>To maintain the scientific integrity of this study, we kindly ask that you <strong>do not share</strong></p>
          <p>details about the experimental procedures or purpose with others who might participate.</p> 

          <p>Your data has been saved.</p>
          <p>Participant ID: <strong>${participant_id}</strong></p>
          <p>You may close this window.</p>
        </div>
      `
    };
        timeline.push(thank_you);

        jsPsych.run(timeline);
      })
      .catch(err => console.error("Error loading pairs metadata:", err));



    // ---- functions ----
    function groupRowsIntoPairs(rows) {
      const byPair = {};
      rows.forEach(r => {
        if (!byPair[r.pair_order]) byPair[r.pair_order] = [];
        byPair[r.pair_order].push(r);
      });

      const pairs = [];
      const sortedKeys = Object.keys(byPair).map(Number).sort((a, b) => a - b);
      sortedKeys.forEach(k => {
        const pairRows = byPair[k];
        if (pairRows.length !== 2) {
          console.warn("Pair_num", k, "does not have exactly 2 rows:", pairRows);
          return;
        }

        const r_left  = pairRows.find(r => r.position === "left");
        const r_right = pairRows.find(r => r.position === "right");

        if (!r_left || !r_right) {
          console.warn("Could not find left/right for pair_num", k, pairRows);
          return;
        }

        const left_src  = String(r_left.image_file);
        const right_src = String(r_right.image_file);

        pairs.push({
          pair_order: parseInt(k),
          pair_num: r_left.pair_num,
          left_img: left_src,
          right_img: right_src,
          left_n: r_left.numerosity,
          right_n: r_right.numerosity,
          pair_ratio: r_left.pair_ratio,
          greater_side: r_left.greater_side,
          stimulus_html: `
            <div class="stim-container">
              <img src="${left_src}" class="stim-img">
              <img src="${right_src}" class="stim-img">
            </div>`
        });
      });

      console.log("Example pair object:", pairs[0]); // debug
      console.log("Stimulus HTML example:", pairs[0].stimulus_html); // debug
      return pairs;
    }

    function makeBlock(pairs, blockIndex) {
      const trials = [];

      // block header
      trials.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<div style="text-align:center;"><h2>Block ${blockIndex} of 3</h2><p>Press any key to start.</p></div>`
      });

      const trialTimeline = {
        timeline: [
          // 1) Fixation
          {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div class="fixation-cross">+</div>',
            choices: "NO_KEYS",
            trial_duration: 500
          },
          // 2) Stimulus pair (no response, 250 ms)
          {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: jsPsych.timelineVariable('stimulus_html'),
            choices: "NO_KEYS",
            trial_duration: 250
          },
          // 3) Noise mask
          {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function() {
              return `
                <div class="stim-container">
                  <img src="${MASK_PATH}" class="stim-img">
                  <img src="${MASK_PATH}" class="stim-img">
                </div>`;
            },
            choices: "NO_KEYS",
            trial_duration: 150
          },
          // 4) Black screen until response F/J
          {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div style="width:100vw;height:100vh;background-color:black;"></div>',
            choices: [LEFT_KEY, RIGHT_KEY],
            response_ends_trial: true,
            data: function() {
              const left_n  = jsPsych.timelineVariable('left_n');
              const right_n = jsPsych.timelineVariable('right_n');
              const correct_key = left_n > right_n ? LEFT_KEY : RIGHT_KEY;
              return {
                task: "numerosity_discrimination",
                block: blockIndex,
                pair_order: jsPsych.timelineVariable('pair_order'),
                pair_num: jsPsych.timelineVariable('pair_num'),
                left_n: left_n,
                right_n: right_n,
                pair_ratio: jsPsych.timelineVariable('pair_ratio'),
                correct_key: correct_key
              };
            },
            on_finish: function(data) {
              data.correct = data.response === data.correct_key;
            }
          },
          // 5) ITI 1250-1750 ms
          {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div style="width:100vw;height:100vh;background-color:black;"></div>',
            choices: "NO_KEYS",
            trial_duration: function() {
              return 1250 + Math.floor(rng() * 501);
            }
          }
        ],
        timeline_variables: pairs
      };

      trials.push(trialTimeline);
      return { timeline: trials };
    }

    function makeBreakScreen(blockIndex) {
      if (blockIndex >= 3) return []; // no break after last block
      return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="max-width:600px;margin:auto;text-align:center;">
            <h2>End of Block ${blockIndex}</h2>
            <p>You can take a short break now.</p>
            <p>Press any key to continue to the next block.</p>
          </div>
        `
      };
    }

  </script>
</html>